<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bus Realtime Widget</title>
  <link rel="stylesheet" href="./leaflet.css">
  <script src="./leaflet.js"></script>
  <style>
    :root {
      --bg: #0f1012;
      --glass: rgba(255, 255, 255, 0.05);
      --border: rgba(255, 255, 255, 0.12);
      --accent-green: #22c55e;
      --text-main: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.7);
    }

    * { box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
    body, html { height: 100%; margin: 0; background: var(--bg); color: var(--text-main); overflow: hidden; }

    .container { display: flex; flex-direction: row; height: 100vh; padding: 12px; gap: 12px; }

    /* פאנל תחנות */
    .stops-panel { flex: 0 0 42%; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; }
    .stop-card { background: var(--glass); border: 1px solid var(--border); border-radius: 16px; padding: 12px; }
    .stop-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 800; font-size: 14px; border-bottom: 1px solid var(--border); padding-bottom: 5px; }
    
    /* שורת אוטובוס */
    .bus-row { display: flex; justify-content: space-between; align-items: center; padding: 4px 0; font-size: 13px; }
    .bus-info { display: flex; align-items: center; gap: 6px; flex: 1; min-width: 0; }
    .bus-num { background: #eee; color: #000; padding: 1px 5px; border-radius: 4px; font-weight: 900; }
    .bus-dest { color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; }
    
    /* זמנים */
    .bus-times { display: flex; gap: 6px; font-weight: 700; }
    .time-val { font-variant-numeric: tabular-nums; }
    .is-rt { color: var(--accent-green); text-shadow: 0 0 8px rgba(34, 197, 94, 0.3); }

    /* מפה */
    .map-wrap { flex: 1; position: relative; border-radius: 16px; overflow: hidden; border: 1px solid var(--border); }
    #map { height: 100%; width: 100%; }

    /* HUD על המפה */
    .map-hud { position: absolute; top: 10px; left: 10px; z-index: 1000; display: flex; gap: 8px; align-items: center; }
    .hud-pill { background: rgba(0,0,0,0.6); padding: 6px 10px; border-radius: 20px; font-size: 11px; border: 1px solid var(--border); backdrop-filter: blur(5px); }
    .refresh-btn { background: rgba(0,0,0,0.6); border: 1px solid var(--border); color: white; border-radius: 10px; width: 32px; height: 32px; cursor: pointer; display: grid; place-items: center; }

    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { from {transform:rotate(0deg)} to {transform:rotate(360deg)} }
    .loading-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: grid; place-items: center; }
  </style>
</head>
<body>

<div id="loader" class="loading-overlay">טוען נתונים...</div>

<div class="container">
  <div class="stops-panel" id="stopsInner"></div>

  <div class="map-wrap">
    <div id="map"></div>
    <div class="map-hud">
      <div class="hud-pill">עודכן: <span id="syncTime">--:--</span></div>
      <button class="refresh-btn" onclick="fetchData()">
        <svg id="refreshIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
      </button>
    </div>
  </div>
</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzvwr0C5riL27J4gp7iczj_p1HW58hrSrYP1V8h4BDxcpVYN7HZ620BfViT2sx9ZjeG/exec";
  let map, markers = [];

  // פונקציה להפיכת דקות לשעת הגעה HH:MM
  function minsToHHMM(mins) {
    const d = new Date();
    d.setMinutes(d.getMinutes() + parseInt(mins));
    return d.toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'});
  }

  async function fetchData() {
    const icon = document.getElementById('refreshIcon');
    icon.classList.add('spin');
    try {
      const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej));
      const { latitude: lat, longitude: lon } = pos.coords;

      // קריאה ל-URL המדויק שלך
      const response = await fetch(`${SCRIPT_URL}?lat=${lat}&lon=${lon}`);
      const data = await response.json();

      renderUI(data);
      initMap(lat, lon, data.stations);
      
      document.getElementById('syncTime').innerText = new Date().toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit'});
    } catch (e) {
      console.error("Error:", e);
    } finally {
      icon.classList.remove('spin');
      document.getElementById('loader').style.display = 'none';
    }
  }

  function renderUI(data) {
    const container = document.getElementById('stopsInner');
    container.innerHTML = '';

    // מעבר על התחנות (לפי המבנה של הסקריפט שלך)
    Object.values(data.stations).slice(0, 3).forEach(s => {
      let busHtml = '';
      
      Object.values(s.buses).forEach(b => {
        if (!b["1"]) return; // דילוג על קווים ריקים

        // עיבוד זמנים: ירוק ל-rtVals, רגיל ל-schVals
        let timesMarkup = '';
        
        // זמן אמת (ירוק + המרה לשעה)
        if (b.rtVals && b.rtVals.length > 0) {
          b.rtVals.forEach(m => {
            const display = m <= 0 ? "עכשיו" : minsToHHMM(m);
            timesMarkup += `<span class="time-val is-rt">${display}</span>`;
          });
        }
        
        // לוחות זמנים (לבן)
        if (b.schVals && b.schVals.length > 0) {
          b.schVals.forEach(t => {
            if (t.includes(':')) { // רק מה שנראה כמו שעה
              timesMarkup += `<span class="time-val">${t}</span>`;
            }
          });
        }

        busHtml += `
          <div class="bus-row">
            <div class="bus-info">
              <span class="bus-num">${b["1"]}</span>
              <span class="bus-dest">${b["2"]}</span>
            </div>
            <div class="bus-times">${timesMarkup}</div>
          </div>`;
      });

      container.innerHTML += `
        <div class="stop-card">
          <div class="stop-header">
            <span>${s.stationName}</span>
            <span style="opacity:0.6">${s.distance} מ'</span>
          </div>
          ${busHtml || '<div class="bus-row">אין אוטובוסים קרובים</div>'}
        </div>`;
    });
  }

  function initMap(uLat, uLon, stations) {
    if (!map) {
      map = L.map('map', { zoomControl: false, attributionControl: false }).setView([uLat, uLon], 17);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    }

    markers.forEach(m => map.removeLayer(m));
    markers = [];

    // מיקום משתמש
    markers.push(L.circleMarker([uLat, uLon], { radius: 6, color: '#3b82f6', fillOpacity: 1 }).addTo(map));

    // סימון תחנות
    Object.entries(stations).forEach(([key, s]) => {
      const m = L.marker([s.lat, s.lon], {
        icon: L.divIcon({
          className: '',
          html: `<div style="background:#fff; color:#000; width:22px; height:22px; border-radius:50%; text-align:center; font-weight:900; font-size:12px; line-height:22px; border:2px solid #333;">${key}</div>`
        })
      }).addTo(map);
      markers.push(m);
    });

    const group = new L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.2));
  }

  window.onload = fetchData;
</script>
</body>
</html>
