<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="js-widget-title" content="Bus Times - Modern" />
  <title>Bus Times - Modern</title>

  <style>
    :root{
      --bg: #0a0b0d;
      --card-bg: rgba(20, 22, 26, 0.85);
      --glass: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.12);
      --text: #ffffff;
      --text-muted: rgba(255,255,255,.70);
      --accent: #4dabf7;
      --green: #51cf66;
      --green-bg: rgba(81, 207, 102, 0.15);
      
      --fs-xs:  clamp(10px, 1.7vw, 12px);
      --fs-sm:  clamp(11px, 1.9vw, 13px);
      --fs-md:  clamp(12px, 2.1vw, 14px);
      --fs-lg:  clamp(13px, 2.3vw, 15px);
    }

    * { box-sizing: border-box; }

    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      overflow: hidden;
      color: var(--text);
      font-family: -apple-system, 'Segoe UI', system-ui, Arial;
    }

    body {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* Main layout: side by side without gap */
    .main-container {
      flex: 1;
      display: flex;
      flex-direction: row;
      min-height: 0;
      overflow: hidden;
    }

    /* Left side: stations */
    .stations-panel {
      flex: 0 0 45%;
      display: flex;
      flex-direction: column;
      background: var(--card-bg);
      padding: 1.5vh 1.5vw;
      overflow-y: auto;
      overflow-x: hidden;
      gap: 1.2vh;
    }

    /* Right side: static map */
    .map-panel {
      flex: 1;
      position: relative;
      background: #1a1d23;
      overflow: hidden;
    }

    .map-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Map HUD overlay */
    .map-hud {
      position: absolute;
      top: 1vh;
      left: 1vw;
      z-index: 10;
      display: flex;
      align-items: center;
      gap: 0.8vw;
    }

    .hud-time {
      padding: 0.6vh 1vw;
      background: rgba(0,0,0,.5);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 999px;
      backdrop-filter: blur(12px);
      font-size: var(--fs-xs);
      font-weight: 800;
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
    }

    .hud-refresh {
      width: 32px;
      height: 32px;
      background: rgba(0,0,0,.5);
      border: 1px solid rgba(255,255,255,.15);
      border-radius: 10px;
      backdrop-filter: blur(12px);
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: background 0.2s;
    }

    .hud-refresh:hover {
      background: rgba(255,255,255,.08);
    }

    .hud-refresh svg {
      width: 16px;
      height: 16px;
      opacity: 0.9;
    }

    .hud-refresh.spinning svg {
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Station card */
    .station-card {
      background: rgba(255,255,255,.04);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.2vh 1.3vw;
      overflow: hidden;
    }

    .station-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 1vh;
      gap: 1vw;
    }

    .station-name {
      font-size: var(--fs-lg);
      font-weight: 900;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 70%;
    }

    .station-distance {
      font-size: var(--fs-sm);
      font-weight: 800;
      color: var(--text-muted);
      white-space: nowrap;
      font-variant-numeric: tabular-nums;
    }

    /* Bus lines */
    .bus-lines {
      display: flex;
      flex-direction: column;
      gap: 0.8vh;
    }

    .bus-line {
      display: flex;
      align-items: center;
      padding: 0.8vh 1vw;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      gap: 1vw;
    }

    .bus-number {
      font-size: var(--fs-md);
      font-weight: 900;
      min-width: 3ch;
      text-align: center;
    }

    .bus-destination {
      flex: 1;
      font-size: var(--fs-sm);
      font-weight: 600;
      color: var(--text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .bus-times {
      display: flex;
      gap: 0.6vw;
      font-size: var(--fs-sm);
      font-weight: 800;
      font-variant-numeric: tabular-nums;
    }

    .bus-time {
      padding: 0.4vh 0.7vw;
      background: rgba(255,255,255,.08);
      border-radius: 8px;
      white-space: nowrap;
    }

    .bus-time.realtime {
      background: var(--green-bg);
      color: var(--green);
      border: 1px solid rgba(81, 207, 102, 0.3);
    }

    /* Empty state */
    .no-buses {
      text-align: center;
      padding: 2vh 0;
      color: var(--text-muted);
      font-size: var(--fs-sm);
      font-weight: 600;
    }

    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(10, 11, 13, 0.95);
      display: grid;
      place-items: center;
      z-index: 1000;
      backdrop-filter: blur(8px);
    }

    .loading-content {
      text-align: center;
    }

    .loading-title {
      font-size: var(--fs-lg);
      font-weight: 900;
      margin-bottom: 1vh;
    }

    .loading-subtitle {
      font-size: var(--fs-sm);
      font-weight: 600;
      color: var(--text-muted);
    }

    .loading-spinner {
      margin: 2vh auto;
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255,255,255,.1);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    /* Error display */
    .error-message {
      position: fixed;
      top: 2vh;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,59,48,.9);
      color: white;
      padding: 1vh 2vw;
      border-radius: 12px;
      font-size: var(--fs-sm);
      font-weight: 700;
      z-index: 2000;
      max-width: 90%;
      text-align: center;
      backdrop-filter: blur(10px);
      display: none;
    }
  </style>
</head>
<body>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="loading-title">טוען נתונים...</div>
      <div class="loading-spinner"></div>
      <div class="loading-subtitle">אנא המתן</div>
    </div>
  </div>

  <!-- Error Message -->
  <div class="error-message" id="errorMessage"></div>

  <!-- Main Container -->
  <div class="main-container" id="mainContainer" style="visibility: hidden;">
    
    <!-- Left: Stations -->
    <div class="stations-panel" id="stationsPanel">
      <!-- Stations will be rendered here -->
    </div>

    <!-- Right: Static Map -->
    <div class="map-panel">
      <img class="map-image" id="mapImage" src="" alt="Map" />
      
      <!-- Map HUD -->
      <div class="map-hud">
        <div class="hud-time" id="hudTime">—</div>
        <button class="hud-refresh" id="refreshBtn" onclick="window.__manualRefresh && window.__manualRefresh()">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
          </svg>
        </button>
      </div>
    </div>

  </div>

<script>
(function(){
  "use strict";

  // Google Script URL - replace with your actual deployed URL
  const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzvwr0C5riL27J4gp7iczj_p1HW58hrSrYP1V8h4BDxcpVYN7HZ620BfViT2sx9ZjeG/exec";
  
  const FETCH_TIMEOUT = 15000; // 15 seconds timeout
  const MAPBOX_TOKEN = "pk.eyJ1IjoiY2xhdWRlYWkiLCJhIjoiY20zYnZ0Zzl5MDJnbTJqczhsdjRsMmU3NyJ9.hw_FOnQuSL5i3Rc8kKWbNQ";

  const $ = (id) => document.getElementById(id);
  const loadingOverlay = $("loadingOverlay");
  const errorMessage = $("errorMessage");
  const mainContainer = $("mainContainer");
  const stationsPanel = $("stationsPanel");
  const mapImage = $("mapImage");
  const hudTime = $("hudTime");
  const refreshBtn = $("refreshBtn");

  let currentLocation = null;
  let currentStations = [];

  function escapeHtml(str) {
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }

  function showLoading(show) {
    loadingOverlay.style.display = show ? "grid" : "none";
  }

  function showError(msg) {
    errorMessage.textContent = msg;
    errorMessage.style.display = "block";
    setTimeout(() => {
      errorMessage.style.display = "none";
    }, 5000);
  }

  function hideError() {
    errorMessage.style.display = "none";
  }

  async function getLocation() {
    return new Promise((resolve) => {
      if (!navigator.geolocation) {
        resolve(null);
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
        () => resolve(null),
        { enableHighAccuracy: false, timeout: 3000, maximumAge: 60000 }
      );
    });
  }

  async function fetchWithTimeout(url, timeout) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeout);
    
    try {
      const response = await fetch(url, { 
        signal: controller.signal,
        cache: "no-store"
      });
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      return await response.json();
    } catch (err) {
      clearTimeout(timeoutId);
      if (err.name === 'AbortError') {
        throw new Error('הבקשה ארכה יותר מדי - נסה שוב');
      }
      throw err;
    }
  }

  function generateStaticMapUrl(userLat, userLon, stations) {
    // Create markers for user and stations
    const markers = [];
    
    // User marker (blue)
    markers.push(`pin-s+4dabf7(${userLon},${userLat})`);
    
    // Station markers (white, numbered)
    stations.slice(0, 8).forEach((station, idx) => {
      if (station.lat && station.lon) {
        markers.push(`pin-s-${idx + 1}+ffffff(${station.lon},${station.lat})`);
      }
    });
    
    // Calculate bounds
    const lats = [userLat, ...stations.filter(s => s.lat).map(s => s.lat)];
    const lons = [userLon, ...stations.filter(s => s.lon).map(s => s.lon)];
    
    const minLat = Math.min(...lats);
    const maxLat = Math.max(...lats);
    const minLon = Math.min(...lons);
    const maxLon = Math.max(...lons);
    
    // Add padding
    const padding = 0.002;
    const bbox = [
      minLon - padding,
      minLat - padding,
      maxLon + padding,
      maxLat + padding
    ].join(',');
    
    // Generate static map URL
    const width = 800;
    const height = 600;
    const style = "streets-v12"; // or "dark-v11" for dark mode
    
    return `https://api.mapbox.com/styles/v1/mapbox/${style}/static/${markers.join(',')}/${bbox}/${width}x${height}@2x?access_token=${MAPBOX_TOKEN}`;
  }

  function renderStations(data) {
    if (!data.stations) {
      stationsPanel.innerHTML = '<div class="no-buses">לא נמצאו תחנות</div>';
      return;
    }

    const stationsArray = Object.values(data.stations)
      .filter(station => station.stationName && station.stationCode)
      .slice(0, 8);

    if (stationsArray.length === 0) {
      stationsPanel.innerHTML = '<div class="no-buses">לא נמצאו תחנות</div>';
      return;
    }

    const html = stationsArray.map((station, idx) => {
      const buses = Object.values(station.buses || {})
        .filter(bus => bus["1"]) // Has line number
        .slice(0, 7);

      const busesHtml = buses.length > 0 
        ? buses.map(bus => {
            const lineNum = bus["1"];
            const destination = bus["2"];
            
            // Process times - rtVals are realtime, schVals are scheduled
            const rtVals = Array.isArray(bus.rtVals) ? bus.rtVals : [];
            const schVals = Array.isArray(bus.schVals) ? bus.schVals : [];
            
            const timesHtml = [...rtVals, ...schVals]
              .slice(0, 4)
              .map((time, timeIdx) => {
                const isRealtime = timeIdx < rtVals.length;
                const className = isRealtime ? 'bus-time realtime' : 'bus-time';
                return `<span class="${className}">${escapeHtml(time)}</span>`;
              })
              .join('');

            return `
              <div class="bus-line">
                <div class="bus-number">${escapeHtml(lineNum)}</div>
                <div class="bus-destination">${escapeHtml(destination)}</div>
                <div class="bus-times">${timesHtml}</div>
              </div>
            `;
          }).join('')
        : '<div class="no-buses">אין זמני הגעה</div>';

      return `
        <div class="station-card">
          <div class="station-header">
            <div class="station-name">${idx + 1}. ${escapeHtml(station.stationName)}</div>
            <div class="station-distance">${station.distance}מ׳</div>
          </div>
          <div class="bus-lines">
            ${busesHtml}
          </div>
        </div>
      `;
    }).join('');

    stationsPanel.innerHTML = html;
    return stationsArray;
  }

  function updateMapAndTime(data) {
    // Update time
    const now = new Date();
    hudTime.textContent = now.toLocaleTimeString('he-IL', { 
      hour: '2-digit', 
      minute: '2-digit',
      second: '2-digit'
    });

    // Generate and update static map
    if (data.userLocation && currentStations.length > 0) {
      const mapUrl = generateStaticMapUrl(
        data.userLocation.lat,
        data.userLocation.lon,
        currentStations
      );
      mapImage.src = mapUrl;
    }
  }

  async function loadData() {
    hideError();
    showLoading(true);
    mainContainer.style.visibility = "hidden";
    refreshBtn.classList.add("spinning");

    try {
      // Get user location first
      const location = await getLocation();
      
      // Build URL with location if available
      let url = GOOGLE_SCRIPT_URL;
      if (location) {
        url += `?lat=${location.lat}&lon=${location.lon}`;
        currentLocation = location;
      }

      // Fetch data from Google Script with extended timeout
      const data = await fetchWithTimeout(url, FETCH_TIMEOUT);

      if (data.error) {
        throw new Error(data.error);
      }

      // Store stations for map generation
      currentStations = renderStations(data);
      
      // Update map and time
      updateMapAndTime(data);

      // Show main content
      mainContainer.style.visibility = "visible";
      showLoading(false);
      
      window.__WIDGET_READY = true;

    } catch (err) {
      console.error("Error loading data:", err);
      showError(err.message || "שגיאה בטעינת הנתונים");
      showLoading(false);
      window.__WIDGET_READY = true;
    } finally {
      refreshBtn.classList.remove("spinning");
    }
  }

  // Manual refresh function
  window.__manualRefresh = () => {
    loadData();
  };

  // Initial load
  window.addEventListener("DOMContentLoaded", () => {
    loadData();
  });

})();
</script>

</body>
</html>
